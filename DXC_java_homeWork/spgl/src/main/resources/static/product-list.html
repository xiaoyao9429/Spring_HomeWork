<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“åˆ—è¡¨ - å•†å“ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- å¤´éƒ¨ -->
    <header class="header">
        <div class="container">
            <h1>å•†å“ç®¡ç†ç³»ç»Ÿ</h1>
        </div>
    </header>

    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="container">
            <ul>
                <li><a href="index.html">é¦–é¡µ</a></li>
                <li><a href="product-list.html">å•†å“åˆ—è¡¨</a></li>
                <li><a href="manage-products.html">ç®¡ç†å•†å“</a></li>
            </ul>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <main class="main">
        <div class="container">
            <h2>å•†å“åˆ—è¡¨</h2>
            
            <!-- æœç´¢å’Œç­›é€‰ -->
            <div class="search-filter">
                <form action="#" method="get">
                    <div class="form-group">
                        <input type="text" name="search" placeholder="æœç´¢å•†å“åç§°...">
                        <select name="category">
                            <option value="">å…¨éƒ¨åˆ†ç±»</option>
                            <option value="1">ç”µå­äº§å“</option>
                            <option value="2">å®¶å±…ç”¨å“</option>
                            <option value="3">æœè£…é‹å¸½</option>
                            <option value="4">é£Ÿå“é¥®æ–™</option>
                        </select>
                        <button type="submit" class="btn">æœç´¢</button>
                    </div>
                </form>
            </div>

            <!-- å•†å“å±•ç¤º -->
            <div class="product-grid">
                <!-- å•†å“å¡ç‰‡1 -->
                <div class="product-card">
                    <div class="product-image">ğŸ“±</div>
                    <div class="product-info">
                        <h4 class="product-name">æ™ºèƒ½æ‰‹æœº</h4>
                        <p class="product-price">Â¥2999.00</p>
                        <p class="product-description">é«˜æ¸…å±å¹•ï¼Œå¼ºå¤§æ€§èƒ½ï¼Œé•¿ç»­èˆª</p>
                        <p class="product-stock">åº“å­˜: 50</p>
                        <a href="product-detail.html?id=1" class="btn">æŸ¥çœ‹è¯¦æƒ…</a>
                    </div>
                </div>

                <!-- å•†å“å¡ç‰‡2 -->
                <div class="product-card">
                    <div class="product-image">ğŸ’»</div>
                    <div class="product-info">
                        <h4 class="product-name">ç¬”è®°æœ¬ç”µè„‘</h4>
                        <p class="product-price">Â¥5999.00</p>
                        <p class="product-description">è½»è–„ä¾¿æºï¼Œé«˜æ€§èƒ½å¤„ç†å™¨</p>
                        <p class="product-stock">åº“å­˜: 30</p>
                        <a href="product-detail.html?id=2" class="btn">æŸ¥çœ‹è¯¦æƒ…</a>
                    </div>
                </div>

                <!-- å•†å“å¡ç‰‡3 -->
                <div class="product-card">
                    <div class="product-image">ğŸ§</div>
                    <div class="product-info">
                        <h4 class="product-name">æ— çº¿è€³æœº</h4>
                        <p class="product-price">Â¥899.00</p>
                        <p class="product-description">é™å™ªåŠŸèƒ½ï¼Œä¼˜è´¨éŸ³è´¨</p>
                        <p class="product-stock">åº“å­˜: 100</p>
                        <a href="product-detail.html?id=3" class="btn">æŸ¥çœ‹è¯¦æƒ…</a>
                    </div>
                </div>

                <!-- å•†å“å¡ç‰‡4 -->
                <div class="product-card">
                    <div class="product-image">âŒš</div>
                    <div class="product-info">
                        <h4 class="product-name">æ™ºèƒ½æ‰‹è¡¨</h4>
                        <p class="product-price">Â¥1299.00</p>
                        <p class="product-description">å¥åº·ç›‘æµ‹ï¼Œè¿åŠ¨è¿½è¸ª</p>
                        <p class="product-stock">åº“å­˜: 45</p>
                        <a href="product-detail.html?id=4" class="btn">æŸ¥çœ‹è¯¦æƒ…</a>
                    </div>
                </div>

                <!-- å•†å“å¡ç‰‡5 -->
                <div class="product-card">
                    <div class="product-image">ğŸ“º</div>
                    <div class="product-info">
                        <h4 class="product-name">æ™ºèƒ½ç”µè§†</h4>
                        <p class="product-price">Â¥3999.00</p>
                        <p class="product-description">4Kåˆ†è¾¨ç‡ï¼Œæ™ºèƒ½ç³»ç»Ÿ</p>
                        <p class="product-stock">åº“å­˜: 25</p>
                        <a href="product-detail.html?id=5" class="btn">æŸ¥çœ‹è¯¦æƒ…</a>
                    </div>
                </div>

                <!-- å•†å“å¡ç‰‡6 -->
                <div class="product-card">
                    <div class="product-image">ğŸ®</div>
                    <div class="product-info">
                        <h4 class="product-name">æ¸¸æˆä¸»æœº</h4>
                        <p class="product-price">Â¥2699.00</p>
                        <p class="product-description">é«˜æ€§èƒ½æ¸¸æˆä½“éªŒ</p>
                        <p class="product-stock">åº“å­˜: 40</p>
                        <a href="product-detail.html?id=6" class="btn">æŸ¥çœ‹è¯¦æƒ…</a>
                    </div>
                </div>
            </div>

            <!-- åˆ†é¡µ -->
            <div class="pagination">
                <a href="#" class="btn">ä¸Šä¸€é¡µ</a>
                <a href="#" class="btn">1</a>
                <a href="#" class="btn">2</a>
                <a href="#" class="btn">3</a>
                <a href="#" class="btn">ä¸‹ä¸€é¡µ</a>
            </div>
        </div>
    </main>

    <!-- é¡µè„š -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 å•†å“ç®¡ç†ç³»ç»Ÿ.</p>
        </div>
    </footer>

    <!-- JavaScript -->
    <script>
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // å½“å‰é¡µç 
            window.currentPage = 1;
            // æ¯é¡µæ˜¾ç¤ºçš„å•†å“æ•°é‡
            window.pageSize = 8;
            // å•†å“æ€»æ•°
            window.totalProducts = 0;
            // æ€»é¡µæ•°
            window.totalPages = 0;
            // åŠ è½½åˆ†ç±»æ•°æ®
            loadCategories();
            // åŠ è½½å•†å“åˆ—è¡¨
            loadProducts();
            
            // æœç´¢è¡¨å•æäº¤äº‹ä»¶
            const searchForm = document.querySelector('.search-filter form');
            searchForm.addEventListener('submit', function(e) {
                e.preventDefault();
                window.currentPage = 1; // æœç´¢æ—¶é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                loadProducts();
            });
        });
        
        // åŠ è½½åˆ†ç±»æ•°æ®å‡½æ•°
        function loadCategories() {
            fetch('/categories')
            .then(response => response.json())
            .then(data => {
                if (data.code === 200 && data.data) {
                    const categories = data.data;
                    const categorySelect = document.querySelector('select[name="category"]');
                    
                    // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™ç¬¬ä¸€ä¸ªâ€œå…¨éƒ¨åˆ†ç±»â€é€‰é¡¹ï¼‰
                    const firstOption = categorySelect.firstElementChild;
                    categorySelect.innerHTML = '';
                    categorySelect.appendChild(firstOption);
                    
                    // åŠ¨æ€ç”Ÿæˆåˆ†ç±»é€‰é¡¹
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.category_name;
                        categorySelect.appendChild(option);
                    });
                } else {
                    console.error('è·å–åˆ†ç±»æ•°æ®å¤±è´¥:', data.msg);
                }
            })
            .catch(error => {
                console.error('è·å–åˆ†ç±»æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯:', error);
            });
        }
        
        // åŠ è½½å•†å“åˆ—è¡¨å‡½æ•°
        function loadProducts() {
            // è·å–æœç´¢å‚æ•°
            const searchInput = document.querySelector('input[name="search"]');
            const categorySelect = document.querySelector('select[name="category"]');
            const searchValue = searchInput ? searchInput.value : '';
            const categoryValue = categorySelect ? categorySelect.value : '';
            
            // æ„å»ºè¯·æ±‚URLï¼ˆä½¿ç”¨åˆ†é¡µæ¥å£ï¼‰
            let url = `/products/page/${window.currentPage}`;
            let params = [];
            if (searchValue) {
                params.push(`name=${encodeURIComponent(searchValue)}`);
            }
            if (categoryValue) {
                params.push(`category_id=${categoryValue}`);
            }
            if (params.length > 0) {
                url += '?' + params.join('&');
            }
            
            // è·å–å•†å“åˆ—è¡¨
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        const products = data.data;
                        const productGrid = document.querySelector('.product-grid');
                        
                        // æ¸…ç©ºç°æœ‰å•†å“å¡ç‰‡
                        productGrid.innerHTML = '';
                        
                        // è·å–åˆ†ç±»æ•°æ®ç”¨äºæ˜¾ç¤º
                        fetch('/categories')
                        .then(categoryResponse => categoryResponse.json())
                        .then(categoryData => {
                            let categories = [];
                            if (categoryData.code === 200 && categoryData.data) {
                                categories = categoryData.data;
                            }
                            
                            // åŠ¨æ€ç”Ÿæˆå•†å“å¡ç‰‡
                            if (products.length > 0) {
                                products.forEach(product => {
                                    const productCard = document.createElement('div');
                                    productCard.className = 'product-card';
                                    
                                    // åˆ›å»ºå•†å“å›¾ç‰‡
                                    const productImage = document.createElement('div');
                                    productImage.className = 'product-image';
                                    const img = document.createElement('img');
                                    img.src = `photo/${product.product_image}`;
                                    img.alt = product.name;
                                    img.style.width = '100%';
                                    img.style.height = '100%';
                                    img.style.objectFit = 'cover';
                                    productImage.appendChild(img);
                                    
                                    // åˆ›å»ºå•†å“ä¿¡æ¯
                                    const productInfo = document.createElement('div');
                                    productInfo.className = 'product-info';
                                    
                                    // åˆ›å»ºå•†å“åç§°
                                    const productName = document.createElement('h4');
                                    productName.className = 'product-name';
                                    productName.textContent = product.name;
                                    
                                    // åˆ›å»ºå•†å“ä»·æ ¼
                                    const productPrice = document.createElement('p');
                                    productPrice.className = 'product-price';
                                    productPrice.textContent = `Â¥${product.price.toFixed(2)}`;
                                    
                                    // åˆ›å»ºå•†å“æè¿°
                                    const productDescription = document.createElement('p');
                                    productDescription.className = 'product-description';
                                    productDescription.textContent = product.description;
                                    
                                    // åˆ›å»ºå•†å“åº“å­˜
                                    const productStock = document.createElement('p');
                                    productStock.className = 'product-stock';
                                    productStock.textContent = `åº“å­˜: ${product.stock}`;
                                    
                                    // åˆ›å»ºæŸ¥çœ‹è¯¦æƒ…æŒ‰é’®
                                    const viewDetailLink = document.createElement('a');
                                    viewDetailLink.href = `product-detail.html?id=${product.id}`;
                                    viewDetailLink.className = 'btn';
                                    viewDetailLink.textContent = 'æŸ¥çœ‹è¯¦æƒ…';
                                    
                                    // ç»„è£…å•†å“ä¿¡æ¯
                                    productInfo.appendChild(productName);
                                    productInfo.appendChild(productPrice);
                                    productInfo.appendChild(productDescription);
                                    productInfo.appendChild(productStock);
                                    productInfo.appendChild(viewDetailLink);
                                    
                                    // ç»„è£…å•†å“å¡ç‰‡
                                    productCard.appendChild(productImage);
                                    productCard.appendChild(productInfo);
                                    
                                    // æ·»åŠ åˆ°å•†å“ç½‘æ ¼
                                    productGrid.appendChild(productCard);
                                });
                                
                                // è·å–å•†å“æ€»æ•°å¹¶æ›´æ–°åˆ†é¡µæ§ä»¶
                                let countUrl = '/products/number';
                                let countParams = [];
                                if (searchValue) {
                                    countParams.push(`name=${encodeURIComponent(searchValue)}`);
                                }
                                if (categoryValue) {
                                    countParams.push(`category_id=${categoryValue}`);
                                }
                                if (countParams.length > 0) {
                                    countUrl += '?' + countParams.join('&');
                                }
                                fetch(countUrl)
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.code === 200) {
                                            window.totalProducts = data.data;
                                            // è®¡ç®—æ€»é¡µæ•°
                                            window.totalPages = Math.ceil(window.totalProducts / window.pageSize);
                                            // æ›´æ–°åˆ†é¡µæ§ä»¶
                                            updatePagination();
                                        }
                                    })
                                    .catch(error => {
                                        console.error('è·å–å•†å“æ€»æ•°æ—¶å‘ç”Ÿé”™è¯¯:', error);
                                    });
                            } else {
                                // æ²¡æœ‰å•†å“æ—¶æ˜¾ç¤ºæç¤º
                                productGrid.innerHTML = '<p style="text-align: center; width: 100%; padding: 20px;">æš‚æ— å•†å“æ•°æ®</p>';
                                // æ›´æ–°åˆ†é¡µæ§ä»¶ï¼ˆéšè—æˆ–æ˜¾ç¤ºç©ºçŠ¶æ€ï¼‰
                                updatePagination();
                            }
                        })
                        .catch(error => {
                            console.error('è·å–åˆ†ç±»æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯:', error);
                        });
                    } else {
                        alert('è·å–å•†å“åˆ—è¡¨å¤±è´¥: ' + data.msg);
                    }
                })
                .catch(error => {
                    console.error('è·å–å•†å“åˆ—è¡¨æ—¶å‘ç”Ÿé”™è¯¯:', error);
                    alert('è·å–å•†å“åˆ—è¡¨æ—¶å‘ç”Ÿé”™è¯¯');
                });
        }
        
        // æ›´æ–°åˆ†é¡µæ§ä»¶
        function updatePagination() {
            const pagination = document.querySelector('.pagination');
            
            // æ¸…ç©ºç°æœ‰åˆ†é¡µæŒ‰é’®
            pagination.innerHTML = '';
            
            // åˆ›å»ºä¸Šä¸€é¡µæŒ‰é’®
            const prevBtn = document.createElement('a');
            prevBtn.href = '#';
            prevBtn.className = 'btn';
            prevBtn.textContent = 'ä¸Šä¸€é¡µ';
            prevBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (window.currentPage > 1) {
                    window.currentPage--;
                    loadProducts();
                }
            });
            // å¦‚æœæ˜¯ç¬¬ä¸€é¡µï¼Œç¦ç”¨ä¸Šä¸€é¡µæŒ‰é’®
            if (window.currentPage === 1) {
                prevBtn.style.opacity = '0.5';
                prevBtn.style.pointerEvents = 'none';
            }
            pagination.appendChild(prevBtn);
            
            // åˆ›å»ºé¡µç æŒ‰é’®
            if (window.totalPages > 0) {
                // è®¡ç®—æ˜¾ç¤ºçš„é¡µç èŒƒå›´
                let startPage = Math.max(1, window.currentPage - 1);
                let endPage = Math.min(window.totalPages, window.currentPage + 1);
                
                // ç¡®ä¿è‡³å°‘æ˜¾ç¤º3ä¸ªé¡µç ï¼ˆå¦‚æœæ€»é¡µæ•°å¤§äº3ï¼‰
                if (endPage - startPage < 2) {
                    if (startPage === 1) {
                        endPage = Math.min(window.totalPages, startPage + 2);
                    } else if (endPage === window.totalPages) {
                        startPage = Math.max(1, endPage - 2);
                    }
                }
                
                // æ˜¾ç¤ºç¬¬ä¸€ä¸ªé¡µç ï¼ˆå¦‚æœä¸æ˜¯èµ·å§‹é¡µç ï¼‰
                if (startPage > 1) {
                    const firstPageBtn = document.createElement('a');
                    firstPageBtn.href = '#';
                    firstPageBtn.className = 'btn';
                    firstPageBtn.textContent = '1';
                    
                    // å¦‚æœæ˜¯å½“å‰é¡µï¼Œé«˜äº®æ˜¾ç¤º
                    if (1 === window.currentPage) {
                        firstPageBtn.style.backgroundColor = '#4CAF50';
                        firstPageBtn.style.color = 'white';
                    }
                    
                    // é¡µç æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                    firstPageBtn.addEventListener('click', (function(pageNum) {
                        return function(e) {
                            e.preventDefault();
                            window.currentPage = pageNum;
                            loadProducts();
                        };
                    })(1));
                    
                    pagination.appendChild(firstPageBtn);
                    
                    // å¦‚æœç¬¬ä¸€ä¸ªé¡µç å’Œèµ·å§‹é¡µç ä¹‹é—´æœ‰é—´éš”ï¼Œæ˜¾ç¤ºçœç•¥å·
                    if (startPage > 2) {
                        const ellipsis = document.createElement('span');
                        ellipsis.textContent = '...';
                        ellipsis.style.margin = '0 5px';
                        pagination.appendChild(ellipsis);
                    }
                }
                
                // æ˜¾ç¤ºä¸­é—´çš„é¡µç 
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('a');
                    pageBtn.href = '#';
                    pageBtn.className = 'btn';
                    pageBtn.textContent = i;
                    
                    // å¦‚æœæ˜¯å½“å‰é¡µï¼Œé«˜äº®æ˜¾ç¤º
                    if (i === window.currentPage) {
                        pageBtn.style.backgroundColor = '#4CAF50';
                        pageBtn.style.color = 'white';
                    }
                    
                    // é¡µç æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                    pageBtn.addEventListener('click', (function(pageNum) {
                        return function(e) {
                            e.preventDefault();
                            window.currentPage = pageNum;
                            loadProducts();
                        };
                    })(i));
                    
                    pagination.appendChild(pageBtn);
                }
                
                // æ˜¾ç¤ºæœ€åä¸€ä¸ªé¡µç ï¼ˆå¦‚æœä¸æ˜¯ç»“æŸé¡µç ï¼‰
                if (endPage < window.totalPages) {
                    // å¦‚æœç»“æŸé¡µç å’Œæœ€åä¸€ä¸ªé¡µç ä¹‹é—´æœ‰é—´éš”ï¼Œæ˜¾ç¤ºçœç•¥å·
                    if (endPage < window.totalPages - 1) {
                        const ellipsis = document.createElement('span');
                        ellipsis.textContent = '...';
                        ellipsis.style.margin = '0 5px';
                        pagination.appendChild(ellipsis);
                    }
                    
                    const lastPageBtn = document.createElement('a');
                    lastPageBtn.href = '#';
                    lastPageBtn.className = 'btn';
                    lastPageBtn.textContent = window.totalPages;
                    
                    // å¦‚æœæ˜¯å½“å‰é¡µï¼Œé«˜äº®æ˜¾ç¤º
                    if (window.totalPages === window.currentPage) {
                        lastPageBtn.style.backgroundColor = '#4CAF50';
                        lastPageBtn.style.color = 'white';
                    }
                    
                    // é¡µç æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                    lastPageBtn.addEventListener('click', (function(pageNum) {
                        return function(e) {
                            e.preventDefault();
                            window.currentPage = pageNum;
                            loadProducts();
                        };
                    })(window.totalPages));
                    
                    pagination.appendChild(lastPageBtn);
                }
            }
            
            // åˆ›å»ºä¸‹ä¸€é¡µæŒ‰é’®
            const nextBtn = document.createElement('a');
            nextBtn.href = '#';
            nextBtn.className = 'btn';
            nextBtn.textContent = 'ä¸‹ä¸€é¡µ';
            nextBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (window.currentPage < window.totalPages) {
                    window.currentPage++;
                    loadProducts();
                }
            });
            // å¦‚æœæ˜¯æœ€åä¸€é¡µï¼Œç¦ç”¨ä¸‹ä¸€é¡µæŒ‰é’®
            if (window.currentPage >= window.totalPages) {
                nextBtn.style.opacity = '0.5';
                nextBtn.style.pointerEvents = 'none';
            }
            pagination.appendChild(nextBtn);
        }
    </script>
</body>
</html>